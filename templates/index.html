<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betting Strategy Performance Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">Performance Dashboard</span>
        </div>
    </nav>

    <div class="container mt-4">
        
        <!-- Date Range Selector -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-3">
                                <label for="start-date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start-date">
                            </div>
                            <div class="col-md-3">
                                <label for="end-date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end-date">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary me-2" onclick="loadData()">Apply Filter</button>
                                <button class="btn btn-outline-secondary" onclick="resetDates()">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPI Cards -->
        <div class="row row-cols-1 row-cols-md-4 g-4 mb-5">
            <div class="col">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Total Bets</h5>
                        <p class="card-text fs-2" id="total-bets">-</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Win Rate</h5>
                        <p class="card-text fs-2" id="win-rate">-</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Net Profit</h5>
                        <p class="card-text fs-2" id="net-profit">-</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-muted">ROI (%)</h5>
                        <p class="card-text fs-2" id="roi">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- First Row of Charts -->
        <div class="row g-4 mb-5">
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Daily Match Results</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="dailyResultsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Running P&L</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="runningPnlChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row of Charts -->
        <div class="row g-4 mb-5">
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Performance by League</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="leaguePerformanceChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Performance by Bet Type</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="typePerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Bets Table -->
        <div class="card shadow-sm mb-5">
            <div class="card-header bg-white">
                <h5 class="mb-0">Recent Bets Log</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="bet-history-table">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Match</th>
                                <th>League</th>
                                <th>Bet Type</th>
                                <th>Outcome</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // Initialize date inputs and load data
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            const oneMonthAgoStr = oneMonthAgo.toISOString().split('T')[0];
            
            document.getElementById('start-date').value = oneMonthAgoStr;
            document.getElementById('end-date').value = today;
            
            loadData();
        });
        
        function resetDates() {
            const today = new Date().toISOString().split('T')[0];
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            const oneMonthAgoStr = oneMonthAgo.toISOString().split('T')[0];
            
            document.getElementById('start-date').value = oneMonthAgoStr;
            document.getElementById('end-date').value = today;
            
            loadData();
        }
        
        function loadData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            fetch(`/api/dashboard_data?start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    updateKPIs(data.kpis);
                    createDailyResultsChart(data.daily_results);
                    createRunningPnlChart(data.running_pnl);
                    createPerformanceCharts(data);
                    updateRecentBets(data.recent_bets);
                })
                .catch(error => console.error('Error loading data:', error));
        }
        
        function updateKPIs(kpis) {
            document.getElementById('total-bets').textContent = kpis.total_bets;
            document.getElementById('win-rate').textContent = `${kpis.win_rate}%`;
            
            const netProfitEl = document.getElementById('net-profit');
            netProfitEl.textContent = kpis.net_profit;
            netProfitEl.className = `card-text fs-2 ${kpis.net_profit >= 0 ? 'text-success' : 'text-danger'}`;
            
            const roiEl = document.getElementById('roi');
            roiEl.textContent = `${kpis.roi}%`;
            roiEl.className = `card-text fs-2 ${kpis.roi >= 0 ? 'text-success' : 'text-danger'}`;
        }
        
        function createDailyResultsChart(dailyData) {
            const ctx = document.getElementById('dailyResultsChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (window.dailyResultsChart) {
                window.dailyResultsChart.destroy();
            }
            
            window.dailyResultsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyData.map(item => item.date),
                    datasets: [
                        {
                            label: 'Wins',
                            data: dailyData.map(item => item.wins),
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Losses',
                            data: dailyData.map(item => item.losses),
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Number of Bets'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const data = dailyData[context[0].dataIndex];
                                    return `Net: ${data.net >= 0 ? '+' : ''}${data.net}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createRunningPnlChart(pnlData) {
            const ctx = document.getElementById('runningPnlChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (window.runningPnlChart) {
                window.runningPnlChart.destroy();
            }
            
            window.runningPnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: pnlData.map(item => item.date),
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: pnlData.map(item => item.pnl),
                        borderColor: 'rgba(0, 123, 255, 1)',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Profit/Loss'
                            }
                        }
                    }
                }
            });
        }
        
        function createPerformanceCharts(data) {
            // League Performance Chart
            const leagueCtx = document.getElementById('leaguePerformanceChart').getContext('2d');
            const leagueLabels = Object.keys(data.performance_by_league);
            const leagueWins = leagueLabels.map(league => data.performance_by_league[league].wins);
            const leagueLosses = leagueLabels.map(league => data.performance_by_league[league].losses);
            
            if (window.leaguePerformanceChart) {
                window.leaguePerformanceChart.destroy();
            }
            
            window.leaguePerformanceChart = new Chart(leagueCtx, {
                type: 'bar',
                data: {
                    labels: leagueLabels,
                    datasets: [
                        {
                            label: 'Wins',
                            data: leagueWins,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)'
                        },
                        {
                            label: 'Losses',
                            data: leagueLosses,
                            backgroundColor: 'rgba(220, 53, 69, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Type Performance Chart
            const typeCtx = document.getElementById('typePerformanceChart').getContext('2d');
            const typeLabels = Object.keys(data.performance_by_type);
            const typeWins = typeLabels.map(type => data.performance_by_type[type].wins);
            const typeLosses = typeLabels.map(type => data.performance_by_type[type].losses);
            
            if (window.typePerformanceChart) {
                window.typePerformanceChart.destroy();
            }
            
            window.typePerformanceChart = new Chart(typeCtx, {
                type: 'bar',
                data: {
                    labels: typeLabels,
                    datasets: [
                        {
                            label: 'Wins',
                            data: typeWins,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)'
                        },
                        {
                            label: 'Losses',
                            data: typeLosses,
                            backgroundColor: 'rgba(220, 53, 69, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateRecentBets(bets) {
            const tableBody = document.querySelector('#bet-history-table tbody');
            tableBody.innerHTML = '';
            
            bets.forEach(bet => {
                const row = document.createElement('tr');
                const date = new Date(bet.placed_at).toLocaleString();
                const outcomeClass = bet.outcome === 'win' ? 'text-success' : 'text-danger';
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${bet.match || 'N/A'}</td>
                    <td>${bet.league || 'N/A'}</td>
                    <td>${bet.bet_type || 'N/A'}</td>
                    <td class="${outcomeClass} fw-bold">${bet.outcome.toUpperCase()}</td>
                `;
                tableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
